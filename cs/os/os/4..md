# 4.운영체제 구조 - 사용자와 커널 모드

## 00. 강의 영역

* 저번 시간까지는   System call 까지를 봄 
*  이번에는 System Call 과 Operating System 부분을 볼 것 임

## 01. CPU Protection Rings

* CPU는 여러 명령어가 존재, 

  이러한 CPU도 권한 모드라는 것을 가지고 있다.

* **CPU의 모드** 
  * **1. 사용자 모드 \[ user mode by applications \] - ring 3**  
    * 응용 프로그램이 사용 
    *  일반적인 명령 실행할 수 있음  
  * **2. 커널 모드\[kernel mode by OS\):\] - ring 0** 
    * OS 가 사용 
    * 특권 명령어 실행 가능
    * 원하는 작업 수행 위한 자원접근 가능케 함  


      -&gt; cpu가 현재 명령어를 실행하고 있는 모드 확인해서  
        , 잘못된 요청이면 거절 ex\) intel cpu 기준으로 설명  
  

cf\) 용어 탐색 

* 1. kernel : OS kernel - 사전적 의미
  *  1\) \(견과류·씨앗의\) 알맹이
  *  2\) \(사상·주제의\) 핵심  → OS 본연의 기능, OS 핵심 소프트웨어를 OS 커널이라고 말함 
* 2. shell - 사전적 의미
  *  1\) \(달걀견과류 등의 딱딱한\) 껍데기
  *  2\) 고둥 껍데기 모양의 것  → OS 를 둘러싸고 있는 껍데기 모양이라 shell 이라 부름

## 02. 응용 프로그램과 운영체제

* 그림          \[응용 프로그램\]                   \[API\] ---\[시스템 호출 인터페이스\]---- \[메모리\] \[디스크\] \[네트워크\] 
*  시스템 호출 인터페이스를 기준으로,  위쪽은 사용자 모드에서 실행되는 것이고,  그 요청이 밑으로 내려가게 되면, **커널 모드**에서 실행이 된다는 의미
* ex\)

  * 1\) 1~1000 까지의 합 이후 - \[응용 프로그램\]에서 실행
  * 2\) 파일에서 데이터 가져와서
  * 3\) \[1\] 과 \[2\] 을 더한 후 - \[응용 프로그램에서 실행\] 
  * 4\) \[3\] 을 출력

* 여기서 \[1\] \[3\] 은 \[응용 프로그램\]에서 동작 ,  그러나  \[3\]은 시스템 콜을 통해 커널 영역으로 이동한 후   os 에서 디스크를 가져오는 작업이 필요   -&gt; **우리가 응용 프로그램을 실행하는 과정에서,**   **어떤 명령은 사용자 영역에서 실행되고,**   **어떤 명령은 시스템 콜을 통해 커널 영역에서 커널 모드로 실행이 됨** 
* **시스템 콜은 커널 모드로 실행** 
  * 커널 모드에서만 실행 가능한 기능들이 있음  → 이것들을 운영체제 안에 구현해 놓음
  * 위의 기능들을 응용 프로그램이 사용하려면, 즉 커널 모드로 실행하려면,  반드시 **시스템 콜을 사용**해서 이것을 거쳐야, 커널 모드로 변환된 상태에서 CPU에서 실행이 된다. 
  *  즉, 위의 기능들을 실행하는 과정은  
     응용 프로그램\[사용자 모드\] → cpu 실행\[커널 모드\]

  *  위의 기능들이 동작하도록 해당 시스템 콜을 운영체제가 제공해야 한다.

    -&gt; 사용자 모드와 커널 모드를 이해하기 위해서는  
       cpu protection ring 이 있다는 것을 기억면 된다.

## 03. 사용자 모드와 커널 모드

* 이를 사용하는 것에 대한 **장점**

  * 1\) 함부로 응용 프로그램이 전체 컴퓨터 시스템을 해치지 못함 

    ex\) 

    \[시민\] 이 주민등록등본 발급 시 동사무소 또는 공인 사이트에서 → 시스템 모드 

    \[특별한 신청서= 시스템 콜\]를 사용해서 신청해야 하는 것과 같다. 

      → 그러면 \[권한\]을 가진 \[동사무소 직원\]이 해당 동작을 실시해 줌  → 커널 모드 

      → 이 결과를 다시 \[시민\]에게 전달 

* cf\) 응용 프로그래머와 시스템 프로그래머의 차이
  *  1\) 응용 프로그래머
    *  : API를 사용하여 사용자 프로그램 \(응용 프로그램\) 을 다룬다.
  * 2\) 시스템 프로그래머
    *  : 운영체제나 shell 등 시스템 프로그램, API, System call, 하드웨어 등을 다룬다.  
* 코드 예시 1 -&gt; 중간에 open\(\)이이라는 함수가 존재 
  * 여기서 open\(\) 의 기능 : 파일을 연다.
  * 그렇다면 file의 위치는? : 저장매체에 존재
  * 그렇다면,  
     \[사용자 모드\]에서 open\(\)이란 \[**시스템 콜\]**을 사용하여  
     \[커널 모드\]로 변환, 그 후  \[OS\] 에 접근하고,   
     \[OS\] 안에 있는 \[커널함수\] 호출하, 저장매체에 들어있는 파일을 열어야 한다.  
     이후 결과값을 전달하기 위해 사용자 모드로 전환된 후 ,  
     나머지 코드를 실행

  * 즉 저 위의 그림에서  
    open\(\) 과정은 \[커널 모드\] .

    open\(\)의 위, 아래는 \[사용자 모드\],라고 볼 수 있다.  
* 코드예시 2   
  \[사용자 프로그램\]   ----   \[ 헤더 파일 \]   ----  \[ 커널 \]   
  


  - open\(\) 함수 : unistd.h 라는 헤더 파일을 가지고있는 라이브러리에 선언된 함수 

  - 헤더 파일을 가지고 ,시스템 콜 호출 가능하도록 제공

  - 커널에서는 이 open\(\)메소드가 호출이 된다면,

    sys\_open\(\)함수가 호출되도록 구현이 되어있음 

즉 \[사용자 모드\] API, - - - - - System call - - - - - - - \[커널 모드\] System call 을 처리하는 운영체제 함수

## 04. 정리

* 운영체제는 **\[시스템 콜\]**을 제공
* 프로그래밍 언어 별 운영체제 기능 활용하기 위해, 시스템 콜을 기반으로 **API** 제공
* 응용 프로그램은 해당 운영체제의 기능이 필요할 때마다, 해당 **API**를 사용해서 프로그램 작성
* 응용 프로그램 실행 후, 해당 운영체제 기능이 필요한 API 호출하면, 시스템 콜이 호출되서, 커널 모드로 변경된 후, OS 내부에서 해당 명령 실행 후 다시 응용 프로그램으로 돌아감

  -&gt; 이렇게 보면 프로그램은 전체 구조 중 윗단에서 작동하는 것 -&gt; 운영체제를 몰랐다면, 윗단만 알고 아랫부분은 모르는 상태였을 것 -&gt; 프로그래머라면, 하드웨어 윗단까지는 이해를 해야 한다.

