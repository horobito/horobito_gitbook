# 4. 리포지터리와 모델 구현

## 01. JPA를 이용한 리포지터리 구현

* 자바 ORM의 표준인 JPA 를 이용, 리포지터리와 애그리거트를 구현하는 방법에 대해 알아본다. 

### 1 . 모듈 위치

* 위치
  * 리포지터리 인테페이스
    * 도메인 영역 
  * 리포지터리를 구현한 클래스
    * 인프라 스트럭쳐 영

### 2. 리포지터리 기본 기능 구현 

* 리포지터리의 기본 기능
  * Id 로 애그리거트 조회
    * ```text
      public Order findById(OrderNo no);
      ```
  * 애그리거트 저장 
    * ```text
      public void save(Order order);
      ```
* 리포지터리 인터페이스는 **애그리거트 루트\(루트 엔티\)**를 기준으로 작성   
* JPA의 EntityManager를 이용한  리포지터리 구현 클래스에서 조회 및 저장 메소드 구
  * ```text
    @Repository
    public class JpaOrderRepository implements OrderRepository(){

        @Override
        public Order findById(){
            return entityManager.find(Order.class, id);
        }
    
        @Override
        public void save(Order order){
            entityManager.persist(order);
        }

    }
    ```



* @Transactional

  * 트렌잭션 범위에서 변경한 데이터를  자동으로  DB에 반영하기 위한 어노테이션ㄹ  
  * 예시
    * ```text

      public class ~~~Service{


         @Transcational
         public void change~~~~(){
   
         }
      }
      ```
    * 여기서 해당 메소드는  스프링 프레임워크의 트랜젝션 관리 기능을 통해 트랜젝션 범위에서 실행  
    * 메소드 실행이 끝나면 트랜잭션을 커밋하는데, 이때 JPA는 트랜잭션 범위에서 변경된 객체의 데이터를 DB에 반영하기 위해 UPDATE 쿼리를 실행 



* Id 가 아닌 다른 조건으로 애그리거트를 조회하는 경우, findBy 뒤에 조건 대상이 되는 프로퍼티 이름을 붙임 







* 리포지터리에서 삭제 기능을 위한 메소드
  * ```text
    public interface OrderRepository{
        public void delete(Order order)
    }
    ```
  * 이는 구현 클래스에서 **Entity Manager**의 **remove\(\) 메소드**를 이용해서 삭제 기능을 구현한다. 
    * ```text
      @Override
      public void remove(){
          entityManager.remove(order);
      }
      ```
  * 참고
    * 여러가지 이유로 인해 \(ex. 데이터의 일정 기간 보\) 데이터를 삭제하는 것 보다는, 삭제 플래그를 이용해서 데이터의 화면 출력 여부를 결정하는 방식으로 구현하는 것이 좋다. 



## 02. 매핑 구현

### 1 . 엔티티와 밸류 기본 매핑 구현

* 애그리거트와 JPA 매핑을 위한 기본 규칙

  * 애그리거트 루트는 앤티티이므로, @Entity로 매핑 설정 
  * 한 테이블에 엔티티와 밸류 데이터가 같이 있다면

    * 밸류는 @Embeddable 로 설정
    * 엔티티의  밸류 타입의 프로퍼티는 @Embedded 로 설정
    * 예시
      * ```text
        public class A{

          @Embedded
          public B b;
        }

        @Embeddable
        public class B{
           @Embeddable
           public C c;

        }

        @Embeddable
        public class C{

        }
        ```
    * JPA2부터  @Embeddable은 중첩을 허용 

* @AttributeOverride 
  * 사용 목적
    * @Embeddable 타입에 설정한 칼럼 이름\(\)과  
      실제 칼럼 이름이 다르므로,  
      해당 어노테이션을 이용해서 매핑할 칼럼 이름을 변  
  * 예시1
    * ```text
      @Entity
      public class Order{
         @Embedded
         public Orderer orderer

      }




      @Entity
      @Embeddable
      public class Orderer(){
          ...
          @Embedded
          @AttributeOverrides(
             @AttributeOverride(
             // MmeberId의 필드 이름 "id"
                name = "id",
          
             //memberId 프로퍼티와 매핑되는 칼럼이름이
             // orderer_id
             // @AttributeOverrides 를 붙이는 이유
             // @Embeddable 타입에 설정한 칼럼 이름인
             // member_id 와
             // 실제 칼럼 이름인
             // orderer_id
             //  다르기 때문   
             // 매핑할 때 해당 어노테이션 이용하여
             // 매핑할 칼럼 이름을 변
                column = @Column(nane = "orderer_id)
             )
          )
          public MemberId memberId
      }


      @Embeddable
      public class MemberId{
         @Column(name='member_id')
         private String id

      }
      ```
  * 예시2
    * ```text
      @Embeddable
      public class ShippingInfo{
         @Embedded
         @AttributeOverrides{
            @AttributeOverride(
              name = "zipcode,
              column = @Column(name = "shipping_zipcode)
            )
      
            @AttributeOverride(
              name = "address1",
              column = @Column(name = "shipping_addr1")
            )
            @AttributeOverride .... 
   
         }
      }

      @Embeddable
      public class Address{

        @Column(name = "Shipping_message)
        public String zipCode;
  
        @Column(name = ~~~)
        public String address1;
  
        @Column(name = ~~~)
        public String address2;
      }

      ```

### 2. 기본 생성자

* 
### 3. 필드 접근 방식 사용

### 4. 밸류 컬렉션1 : 별도 테이블 메핑

### 5. 밸류 컬렉션 2 : 한 개 칼럼 매핑

### 6. 밸류를 이용한 아이디 매핑

### 7. 별도 테이블에 저장하는 벨류 매핑

### 8. 밸류 컬렉션을 @Entity로 매핑하기

### 9. ID 참조와 조인 테이블을 이용한 단방향 M-N 매



## 03. 애그리거트 로딩 전략

## 04. 애그리거트의 영속성 전파

## 05. 식별자 생성 기

